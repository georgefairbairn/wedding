---
import Button from "../button/Button.astro";
import Polaroid from "../polaroid/Polaroid.astro";

const { formName, description, image, priceId, amount } = Astro.props;
---

<form
  id={formName}
  method="POST"
  action={`/api/${formName}`}
  data-name={formName}
  data-priceId={priceId}
  class="flex max-w-md flex-col"
>
  <div class="flex flex-col">
    <div class="bg-transparent perspective-midrange">
      <div>
        <div class="relative">
          <Polaroid src={image} imgClassNames="aspect-square object-cover" />
          <div
            class="bg-custom-pink font-balmy absolute top-5 right-5 rounded-sm border-2 border-white px-2 py-1"
          >
            <span class="text-custom-green text-xl">Â£</span><span
              class="text-3xl text-white">{amount}</span
            >
          </div>
        </div>
        <div></div>
      </div>
    </div>
  </div>

  <div class="z-10 mt-4 flex-1">
    <p class="text-center font-bold tracking-[0.25em] text-white uppercase">
      {description}
    </p>
  </div>

  <input id="priceId" class="hidden" name="priceId" required value={priceId} />

  <div class="mt-8 mb-20 flex w-full justify-center">
    <Button id="submitButton" type="submit" text="BUY" />
  </div>
</form>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const forms = document.querySelectorAll("form[data-name]");

    forms.forEach((form) => {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);

        const res = await fetch("/api/gift", {
          method: "POST",
          body: formData,
        });
        const data = await res.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          alert("Error: " + data.error);
        }
      });
    });
  });
</script>
